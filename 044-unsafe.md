# ğŸ” Unsafe.Add ê°œìš”

| í•­ëª©                     | ì„¤ëª…                                                                 |
|--------------------------|----------------------------------------------------------------------|
| ë„¤ì„ìŠ¤í˜ì´ìŠ¤             | `System.Runtime.CompilerServices`                                    |
| ì£¼ìš” ê¸°ëŠ¥                | ref ê¸°ë°˜ í¬ì¸í„° ì—°ì‚°ì²˜ëŸ¼ ë©”ëª¨ë¦¬ ì°¸ì¡° ìœ„ì¹˜ë¥¼ ì´ë™                     |
| ì‚¬ìš© ëª©ì                 | ê³ ì„±ëŠ¥, ì €ìˆ˜ì¤€ ë©”ëª¨ë¦¬ ì ‘ê·¼, Span ì²˜ë¦¬, Native interop ë“±             |
| ì•ˆì „ ì—¬ë¶€                | âŒ íƒ€ì… ì•ˆì „ ë³´ì¥ ì•ˆ ë¨. ëŸ°íƒ€ì„ ì˜¤ë¥˜ ê°€ëŠ¥ì„± ìˆìŒ                      |
| C++ ìœ ì‚¬ì„±               | `*(ptr + offset)` ë˜ëŠ” `&arr[i]`ì™€ ìœ ì‚¬í•œ ë™ì‘                       |
| ëŒ€í‘œ ë©”ì„œë“œ              | `Unsafe.Add`, `Unsafe.As`, `Unsafe.Read`, `Unsafe.Write` ë“±           |
| ì‚¬ìš© ì¡°ê±´                | `unsafe` í‚¤ì›Œë“œ ì—†ì´ë„ ì‚¬ìš© ê°€ëŠ¥ (ë‹¨, ì¡°ì‹¬í•´ì„œ ì¨ì•¼ í•¨)              |
| JIT ìµœì í™” ì˜í–¥          | JIT ì»´íŒŒì¼ëŸ¬ê°€ ìµœì í™”ì— í™œìš© ê°€ëŠ¥ (ì„±ëŠ¥ í–¥ìƒ ëª©ì )                   |



## ğŸ§  ì½”ë“œ íë¦„ í•´ì„¤
```csharp
int[] a = new[] {123, 234, 345, 456};
```

- ë°°ì—´ ì„ ì–¸. ë©”ëª¨ë¦¬ìƒ ì—°ì†ëœ int ê°’ë“¤ì´ ì €ì¥ë¨.
## ğŸ§  ì½”ë“œ íë¦„ í•´ì„¤
```csharp
ref int r1 = ref Unsafe.Add(ref a[0], 1); // a[1] ì°¸ì¡°
int[] a = new[] {123, 234, 345, 456};
```

- a[0] ê¸°ì¤€ìœ¼ë¡œ +1 ìœ„ì¹˜ â†’ a[1]ì¸ 234ë¥¼ ì°¸ì¡°
```csharp
ref int r2 = ref Unsafe.Add(ref r1, 2); // a[3] ì°¸ì¡°
```

- r1 ê¸°ì¤€ìœ¼ë¡œ +2 ìœ„ì¹˜ â†’ a[3]ì¸ 456ì„ ì°¸ì¡°
```csharp
ref int r3 = ref Unsafe.Add(ref r2, -3); // a[0] ì°¸ì¡°
```

- r2 ê¸°ì¤€ìœ¼ë¡œ -3 ìœ„ì¹˜ â†’ ë‹¤ì‹œ a[0]ì¸ 123 ì°¸ì¡°

## âš ï¸ ì£¼ì˜í•  ì 
- Unsafe.AddëŠ” ë°°ì—´ ê²½ê³„ë¥¼ ê²€ì‚¬í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì—, ì˜ëª»ëœ offsetì„ ì£¼ë©´ ë©”ëª¨ë¦¬ ì˜¤ë¥˜ë‚˜ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ë™ì‘ì´ ë°œìƒí•  ìˆ˜ ìˆì–´ìš”.
- C++ì²˜ëŸ¼ í¬ì¸í„° ì—°ì‚°ì„ í‰ë‚´ë‚´ì§€ë§Œ, C#ì˜ íƒ€ì… ì•ˆì „ì„±ê³¼ ëŸ°íƒ€ì„ ë³´í˜¸ë¥¼ ìš°íšŒí•˜ëŠ” ë°©ì‹ì´ê¸° ë•Œë¬¸ì— ì •ë§ í•„ìš”í•œ ê²½ìš°ì—ë§Œ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.


## ğŸ§ª ì‹œë‚˜ë¦¬ì˜¤: ë„¤ì´í‹°ë¸Œì—ì„œ ë„˜ì–´ì˜¨ int[4] ë°°ì—´ì„ Unsafeë¡œ ë¶„í•´
```csharp
using System;
using System.Runtime.InteropServices;
using System.Runtime.CompilerServices;

class Program
{
    static void Main()
    {
        // ë„¤ì´í‹°ë¸Œì—ì„œ ë„˜ì–´ì˜¨ ë°°ì—´ì„ ì‹œë®¬ë ˆì´ì…˜
        int[] nativeArray = new int[] { 100, 200, 300, 400 };

        // ë°°ì—´ì„ unmanaged ë©”ëª¨ë¦¬ë¡œ ë³µì‚¬
        IntPtr unmanagedPtr = Marshal.AllocHGlobal(sizeof(int) * nativeArray.Length);
        Marshal.Copy(nativeArray, 0, unmanagedPtr, nativeArray.Length);

        try
        {
            // Unsafeë¥¼ ì‚¬ìš©í•˜ì—¬ í¬ì¸í„°ì²˜ëŸ¼ ì ‘ê·¼
            unsafe
            {
                int* basePtr = (int*)unmanagedPtr;

                // refë¡œ ì ‘ê·¼
                ref int r0 = ref Unsafe.AsRef<int>(basePtr);
                ref int r1 = ref Unsafe.Add(ref r0, 1);
                ref int r2 = ref Unsafe.Add(ref r0, 2);
                ref int r3 = ref Unsafe.Add(ref r0, 3);

                Console.WriteLine($"r0: {r0}"); // 100
                Console.WriteLine($"r1: {r1}"); // 200
                Console.WriteLine($"r2: {r2}"); // 300
                Console.WriteLine($"r3: {r3}"); // 400
            }
        }
        finally
        {
            Marshal.FreeHGlobal(unmanagedPtr); // ë©”ëª¨ë¦¬ í•´ì œ
        }
    }
}
```



## ğŸ” í•µì‹¬ í¬ì¸íŠ¸

| í•­ëª©                     | ì„¤ëª…                                                                 |
|--------------------------|----------------------------------------------------------------------|
| ë©”ëª¨ë¦¬ ë³µì‚¬              | `Marshal.Copy`ë¡œ managed â†’ unmanaged ë©”ëª¨ë¦¬ë¡œ ë³µì‚¬                   |
| í¬ì¸í„° ì ‘ê·¼              | `IntPtr`ë¥¼ `int*`ë¡œ ìºìŠ¤íŒ…í•˜ì—¬ í¬ì¸í„°ì²˜ëŸ¼ ì ‘ê·¼                       |
| ref ë³€í™˜                 | `Unsafe.AsRef<T>()`ë¡œ í¬ì¸í„°ë¥¼ `ref T`ë¡œ ë³€í™˜                         |
| í¬ì¸í„° ì—°ì‚°              | `Unsafe.Add(ref, offset)`ë¡œ C++ì²˜ëŸ¼ ë©”ëª¨ë¦¬ ìœ„ì¹˜ ì´ë™                  |
| ë©”ëª¨ë¦¬ í•´ì œ              | `Marshal.FreeHGlobal`ë¡œ unmanaged ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€                    |
| unsafe ë¸”ë¡              | í¬ì¸í„° ì‚¬ìš©ì„ ìœ„í•´ `unsafe` í‚¤ì›Œë“œ í•„ìš”                              |
| ì•ˆì •ì„± ê²½ê³               | ê²½ê³„ ê²€ì‚¬ ì—†ìŒ â†’ ì˜ëª»ëœ offsetì€ ì˜ˆì™¸ ì—†ì´ ì˜ëª»ëœ ë©”ëª¨ë¦¬ ì ‘ê·¼ ìœ ë°œ    |
| ì„±ëŠ¥ ì´ì                 | ê²½ê³„ ê²€ì‚¬ ì œê±° + JIT ìµœì í™”ë¡œ ê³ ì„±ëŠ¥ ì²˜ë¦¬ ê°€ëŠ¥                        |
| ì‚¬ìš© ì‹œê¸°                | Native interop, êµ¬ì¡°ì²´ ë¶„í•´, ê³ ì„±ëŠ¥ ë„¤íŠ¸ì›Œí¬ ì²˜ë¦¬ ë“±ì—ì„œ ìœ ìš©         |




## ğŸ§  C#ì´ C++ì²˜ëŸ¼ ì“¸ ìˆ˜ ìˆëŠ” ì´ìœ 
| ê¸°ëŠ¥ ì˜ì—­               | C#ì—ì„œì˜ êµ¬í˜„ ë°©ì‹                                      | C++ê³¼ì˜ ìœ ì‚¬ì„±                           |
|------------------------|--------------------------------------------------------|------------------------------------------|
| í¬ì¸í„° ì—°ì‚°             | `unsafe`, `fixed`, `Unsafe.Add`, `IntPtr`             | C++ì˜ `int*`, `ptr + offset`             |
| ìŠ¤íƒ ë©”ëª¨ë¦¬ í• ë‹¹        | `stackalloc`, `Span<T>`, `ref struct`                 | C++ì˜ ìŠ¤íƒ ê¸°ë°˜ ë°°ì—´ (`int arr[10]`)     |
| êµ¬ì¡°ì²´ ë©”ëª¨ë¦¬ ì œì–´      | `[StructLayout]`, `FieldOffset`, `Marshal`            | C++ì˜ `struct` ë©”ëª¨ë¦¬ ë°°ì¹˜ ì œì–´          |
| ë©”ëª¨ë¦¬ ìºìŠ¤íŒ…           | `Unsafe.As<TFrom, TTo>()`, `MemoryMarshal.Cast`       | C++ì˜ `reinterpret_cast`                 |
| Native ì½”ë“œ ì—°ë™        | `DllImport`, `Marshal`, `GCHandle`, `IntPtr`          | C++ì˜ extern linkage, ì§ì ‘ í˜¸ì¶œ          |
| ê²½ê³„ ì—†ëŠ” ì ‘ê·¼          | `Unsafe.Read`, `Unsafe.Write`, `Add`, `SkipInit` ë“±   | C++ì˜ unchecked ë°°ì—´ ì ‘ê·¼                |
| ì„±ëŠ¥ ìµœì í™”             | `AggressiveInlining`, `Span<T>`, `SIMD`, `JIT` íŒíŠ¸    | C++ì˜ ì»´íŒŒì¼ëŸ¬ ì¸ë¼ì¸ ë° ìµœì í™”          |
| ë©”ëª¨ë¦¬ ì§ì ‘ ì œì–´        | `Marshal.AllocHGlobal`, `FreeHGlobal`, `GCHandle`     | C++ì˜ `malloc


## ğŸš§ GCê°€ ë§Œë“œëŠ” ì°¨ì´ì 
- C#ì€ ê°ì²´ ìƒëª…ì£¼ê¸°ë¥¼ ìë™ìœ¼ë¡œ ê´€ë¦¬í•˜ì§€ë§Œ, ê·¸ë§Œí¼ ì˜ˆì¸¡ ë¶ˆê°€ëŠ¥í•œ ì‹œì ì— GCê°€ ì‘ë™í•´ìš”.
- C++ì€ ê°œë°œìê°€ ì§ì ‘ new/delete ë˜ëŠ” RAIIë¡œ ë©”ëª¨ë¦¬ë¥¼ ê´€ë¦¬í•˜ë¯€ë¡œ ì œì–´ê¶Œì´ ì™„ì „íˆ ê°œë°œìì—ê²Œ ìˆìŒ.
- C#ì—ì„œ GCHandle, fixed, pinned object ë“±ì„ ì¨ì„œ GCì˜ ì˜í–¥ì„ ì¤„ì¼ ìˆ˜ëŠ” ìˆì§€ë§Œ, ì™„ì „íˆ ì—†ì•¨ ìˆ˜ëŠ” ì—†ì–´ìš”.
